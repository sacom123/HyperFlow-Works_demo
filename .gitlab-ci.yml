stages: [auth, build, deploy]

# ì•ˆì „í•œ ê¸°ë³¸ê°’(ì½œë¡  í¬í•¨ ë¬¸ìžëŠ” í•­ìƒ ë”°ì˜´í‘œ)
variables:
  SERVICE_NAME: 'hyperflow-works'
  IMAGE: '${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_AR_REPO}/${SERVICE_NAME}:${CI_COMMIT_SHA}'

auth:
  auth:
  stage: auth
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: 'https://gitlab.com'
  script:
    # ê¸°ë³¸ í™•ì¸
    - 'test -n "${GCP_WIF_PROVIDER}" || (echo "GCP_WIF_PROVIDER empty" && exit 1)'
    - 'test -n "${GCP_SERVICE_ACCOUNT}" || (echo "GCP_SERVICE_ACCOUNT empty" && exit 1)'
    - 'test -n "${GITLAB_OIDC_TOKEN}" || (echo "GITLAB_OIDC_TOKEN empty" && exit 1)'
    - echo "OIDC token length: ${#GITLAB_OIDC_TOKEN}"
    - echo -n "$GITLAB_OIDC_TOKEN" > /tmp/oidc_token

    # ðŸ”§ ì—¬ê¸°! heredoc ë”°ì˜´í‘œ ì œê±°í•´ì„œ ë³€ìˆ˜ í™•ìž¥ë˜ê²Œ
    - |
      cat > /tmp/wif.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${GCP_WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "file": "/tmp/oidc_token" }
      }
      EOF

    # ë””ë²„ê·¸: ê´€ê±´ì´ë˜ ë‘ ì¤„ë§Œ í™•ì¸(ë§ˆìŠ¤í‚¹ ì—†ì´ ë…¸ì¶œë˜ë©´ ì•ˆ ë˜ë‹ˆ ë¶€ë¶„ë§Œ)
    - grep -E '"audience"|service_account_impersonation_url' /tmp/wif.json || true

    - export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/tmp/wif.json
    - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/wif.json
    - gcloud auth login --cred-file=/tmp/wif.json --no-launch-browser --quiet
    - gcloud config set project "${GCP_PROJECT_ID}"
    - gcloud auth list
  artifacts:
    paths:
      - /tmp/wif.json
      - /tmp/oidc_token
    expire_in: '1h'

build:
  stage: build
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  needs: ['auth']
  script:
    # Dockerfile ë¹Œë“œ (ë˜ëŠ” --pack ì‚¬ìš© ê°€ëŠ¥)
    - gcloud builds submit --tag "${IMAGE}" .
  artifacts:
    reports:
      dotenv: build.env
  after_script:
    - echo "IMAGE=${IMAGE}" >> build.env
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy:
  stage: deploy
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  needs: ['build']
  script:
    - source build.env
    - gcloud run deploy "${SERVICE_NAME}" \
      --image "${IMAGE}" \
      --region "${GCP_REGION}" \
      --platform managed \
      --allow-unauthenticated \
      --service-account "${GCP_SERVICE_ACCOUNT}" \
      --memory "512Mi" \
      --cpu "1" \
      --port "3000"
    - gcloud run services describe "${SERVICE_NAME}" \
      --region "${GCP_REGION}" \
      --format='value(status.url)'
  environment:
    name: 'production'
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
