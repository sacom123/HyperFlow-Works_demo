stages: [auth, build, deploy]

# Cloud Run 서비스명은 변수로 관리
variables:
  SERVICE_NAME: 'hyperflow-works'
  # 이미지 경로 (Artifact Registry)
  IMAGE: '${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_AR_REPO}/${SERVICE_NAME}:${CI_COMMIT_SHA}'

# 1) GitLab OIDC 토큰 → WIF로 교환하여 gcloud 로그인 (키 파일 불필요)
auth:
  stage: auth
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: 'https://gitlab.com'
  script:
    - |
      # 기본 확인
      test -n "${GCP_WIF_PROVIDER}" || (echo "GCP_WIF_PROVIDER empty" && exit 1)
      test -n "${GCP_SERVICE_ACCOUNT}" || (echo "GCP_SERVICE_ACCOUNT empty" && exit 1)
      test -n "${GITLAB_OIDC_TOKEN}" || (echo "GITLAB_OIDC_TOKEN empty" && exit 1)
      echo "OIDC token length: ${#GITLAB_OIDC_TOKEN}"
      echo -n "$GITLAB_OIDC_TOKEN" > /tmp/oidc_token

      # WIF 설정 파일 생성
      cat > /tmp/wif.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${GCP_WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "file": "/tmp/oidc_token" }
      }
      EOF

      # 인증 설정
      export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/tmp/wif.json
      export GOOGLE_APPLICATION_CREDENTIALS=/tmp/wif.json
      gcloud auth login --cred-file=/tmp/wif.json --no-launch-browser --quiet
      gcloud config set project "${GCP_PROJECT_ID}"
      gcloud auth list
  artifacts:
    paths:
      - /tmp/wif.json
      - /tmp/oidc_token
    expire_in: '1h'

# 2) Cloud Build가 Docker 이미지를 빌드하고 Artifact Registry로 푸시
#    (docker:dind 불필요, Runner에 Docker 없어도 됨)
build:
  stage: build
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: 'https://gitlab.com'
  script:
    - |
      # 기본 확인
      test -n "${GCP_WIF_PROVIDER}" || (echo "GCP_WIF_PROVIDER empty" && exit 1)
      test -n "${GCP_SERVICE_ACCOUNT}" || (echo "GCP_SERVICE_ACCOUNT empty" && exit 1)
      test -n "${GITLAB_OIDC_TOKEN}" || (echo "GITLAB_OIDC_TOKEN empty" && exit 1)

      # OIDC 토큰 저장
      echo -n "$GITLAB_OIDC_TOKEN" > /tmp/oidc_token

      # WIF 설정 파일 생성
      cat > /tmp/wif.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${GCP_WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "file": "/tmp/oidc_token" }
      }
      EOF

      # 인증 설정
      export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/tmp/wif.json
      export GOOGLE_APPLICATION_CREDENTIALS=/tmp/wif.json
      gcloud auth login --cred-file=/tmp/wif.json --no-launch-browser --quiet
      gcloud config set project "${GCP_PROJECT_ID}"
      gcloud auth list

      # Docker 이미지 빌드 및 푸시
      # --async 플래그를 사용하여 비동기로 빌드 시작 (로그 스트리밍 권한 문제 회피)
      BUILD_ID=$(gcloud builds submit --async --tag "${IMAGE}" . --format="value(id)")
      echo "✅ Build started with ID: ${BUILD_ID}"
      echo "Build URL: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=${GCP_PROJECT_ID}"

      # 빌드 완료까지 폴링 (최대 30분, 10초마다 확인)
      echo "Waiting for build to complete..."
      MAX_WAIT_TIME=1800  # 30분 (초)
      POLL_INTERVAL=10    # 10초
      ELAPSED=0

      while [ $ELAPSED -lt $MAX_WAIT_TIME ]; do
        BUILD_STATUS=$(gcloud builds describe "${BUILD_ID}" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
        
        if [ "${BUILD_STATUS}" = "SUCCESS" ]; then
          echo "✅ Build completed successfully!"
          break
        elif [ "${BUILD_STATUS}" = "FAILURE" ] || [ "${BUILD_STATUS}" = "CANCELLED" ] || [ "${BUILD_STATUS}" = "EXPIRED" ]; then
          echo "❌ Build failed with status: ${BUILD_STATUS}"
          echo "Build logs: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=${GCP_PROJECT_ID}"
          exit 1
        elif [ "${BUILD_STATUS}" = "WORKING" ] || [ "${BUILD_STATUS}" = "QUEUED" ]; then
          echo "⏳ Build status: ${BUILD_STATUS} (elapsed: ${ELAPSED}s)"
        else
          echo "⚠️  Build status: ${BUILD_STATUS} (elapsed: ${ELAPSED}s)"
        fi
        
        sleep $POLL_INTERVAL
        ELAPSED=$((ELAPSED + POLL_INTERVAL))
      done

      # 최종 상태 확인
      FINAL_STATUS=$(gcloud builds describe "${BUILD_ID}" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
      if [ "${FINAL_STATUS}" != "SUCCESS" ]; then
        echo "❌ Build did not complete successfully. Final status: ${FINAL_STATUS}"
        echo "Build logs: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=${GCP_PROJECT_ID}"
        exit 1
      fi

      echo "✅ Build completed and image pushed to: ${IMAGE}"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# 3) Cloud Run 배포
deploy:
  stage: deploy
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: 'https://gitlab.com'
  needs:
    - job: build
      artifacts: false
  script:
    - |
      # 기본 확인
      test -n "${GCP_WIF_PROVIDER}" || (echo "GCP_WIF_PROVIDER empty" && exit 1)
      test -n "${GCP_SERVICE_ACCOUNT}" || (echo "GCP_SERVICE_ACCOUNT empty" && exit 1)
      test -n "${GITLAB_OIDC_TOKEN}" || (echo "GITLAB_OIDC_TOKEN empty" && exit 1)

      # OIDC 토큰 저장
      echo -n "$GITLAB_OIDC_TOKEN" > /tmp/oidc_token

      # WIF 설정 파일 생성
      cat > /tmp/wif.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${GCP_WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "file": "/tmp/oidc_token" }
      }
      EOF

      # 인증 설정
      export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/tmp/wif.json
      export GOOGLE_APPLICATION_CREDENTIALS=/tmp/wif.json
      gcloud auth login --cred-file=/tmp/wif.json --no-launch-browser --quiet
      gcloud config set project "${GCP_PROJECT_ID}"
      gcloud auth list

      # Cloud Run 배포
      gcloud run deploy "${SERVICE_NAME}" \
        --image "${IMAGE}" \
        --region "${GCP_REGION}" \
        --platform managed \
        --allow-unauthenticated \
        --service-account "${GCP_SERVICE_ACCOUNT}" \
        --memory "512Mi" \
        --cpu "1" \
        --port "3000"

      # 서비스 URL 출력
      gcloud run services describe "${SERVICE_NAME}" \
        --region "${GCP_REGION}" \
        --format='value(status.url)'
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
