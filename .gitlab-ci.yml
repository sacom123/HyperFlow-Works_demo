stages: [auth, build, deploy]

# Cloud Run 서비스명은 변수로 관리
variables:
  SERVICE_NAME: '${SERVICE_NAME:-hyperflow-works}'
  # 이미지 경로 (Artifact Registry)
  IMAGE: '${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_AR_REPO}/${SERVICE_NAME}:${CI_COMMIT_SHA}'

# 1) GitLab OIDC 토큰 → WIF로 교환하여 gcloud 로그인 (키 파일 불필요)
auth:
  stage: auth
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  script:
    - |
      cat > /tmp/wif.json <<EOF
      {
        "type": "external_account",
        "audience": "//iam.googleapis.com/${GCP_WIF_PROVIDER}",
        "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
        "token_url": "https://sts.googleapis.com/v1/token",
        "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken",
        "credential_source": { "url": "$CI_JOB_JWT_V2", "format": { "type": "text" } }
      }
      EOF
    - gcloud auth login --cred-file=/tmp/wif.json
    - gcloud config set project "${GCP_PROJECT_ID}"
  artifacts:
    paths: [/tmp/wif.json]
    expire_in: 1h

# 2) Cloud Build 가 Docker 이미지를 빌드하고 Artifact Registry로 푸시
#    (docker:dind 불필요, Runner에 Docker 없어도 됨)
build:
  stage: build
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  needs: [auth]
  script:
    # monorepo라면 Dockerfile이 프론트/백엔드 빌드 산출물을 포함하도록 설계하세요.
    # (예: pnpm install/build를 Dockerfile 내에서 수행)
    - gcloud builds submit --tag "${IMAGE}" .
  artifacts:
    reports:
      dotenv: build.env
  after_script:
    - echo "IMAGE=${IMAGE}" >> build.env

# 3) Cloud Run 배포
deploy:
  stage: deploy
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  needs: [build]
  script:
    - source build.env
    - gcloud run deploy "${SERVICE_NAME}" \
      --image "${IMAGE}" \
      --region "${GCP_REGION}" \
      --platform managed \
      --allow-unauthenticated \
      --service-account "${GCP_SERVICE_ACCOUNT}" \
      --memory "512Mi" \
      --cpu "1" \
      --port "3000"
    - gcloud run services describe "${SERVICE_NAME}" \
      --region "${GCP_REGION}" --format='value(status.url)'
  environment:
    name: production
  only:
    - main
    - master
